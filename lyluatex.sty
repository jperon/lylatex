\ProvidesPackage{lyluatex}

% Dependencies
\RequirePackage{luatexbase}
\RequirePackage{luaotfload}
\RequirePackage{kvoptions}
\RequirePackage{graphicx}
\RequirePackage{keycommand}
\RequirePackage{environ}
\RequirePackage{currfile}
\RequirePackage{pdfpages}

\RequirePackage{metalogo}
\newcommand{\lyluatex}{\textit{ly}\LuaTeX}

% Options
\DeclareStringOption[lilypond]{program}
\DeclareStringOption[default]{line-width}
\DeclareStringOption[tmp_ly]{tmpdir}
\DeclareStringOption{includepaths}
\newcommand{\pt}{pt}
\newcommand{\mm}{mm}
\newcommand{\cm}{cm}
\ProcessKeyvalOptions*
% Lua Script
\directlua{
  TMP = '\luatexluaescapestring{\lyluatex@tmpdir}'
  dofile(kpse.find_file("lyluatex.lua"))
  ly_define_program('\luatexluaescapestring{\lyluatex@program}')
  ly_define_includepaths('\luatexluaescapestring{\lyluatex@includepaths}')
}
\newcommand{\lilypondCmd}[1]{%
    \directlua{ly_define_program("\luatexluaescapestring{#1}")}%
    \def\lyluatex@program{#1}
}
\newcommand{\lilypondIncludePaths}[1]{%
    \directlua{ly_define_includepaths('\luatexluaescapestring{#1}')}%
    \def\lyluatex@includepaths{#1}
}

\def\defaultwidth{default}
\catcode`-=11
\ifx\lyluatex@line-width\defaultwidth
\catcode`-=12
% A somewhat dirty trick to determine the line width
\let\bs\textbackslash
{\catcode`p=12 \catcode`t=12 \gdef\un#1pt{#1}}
\newcommand*{\lilywidth}{\the\linewidth}
\else
\catcode`-=11
\let\lilywidth\lyluatex@line-width
\catcode`-=12
\fi
% Staff size for LilyPond
% If this is set to 0 (default) the value is calculated automatically
% from «la taille de police».
\def\staffsize{0}
\let\localstaffsize\staffsize
\let\localwidth\lilywidth


% Main commands
% Inclusion of a .ly file
\newkeycommand*\includely[%
    fullpage=false%
    ,staffsize=\staffsize%
    ,line-width=\lilywidth%
    ,program=\lyluatex@program%
    ,includepaths=\lyluatex@includepaths%
    ][other-options][1]{%
\directlua{ly_define_program("\luatexluaescapestring{\commandkey{program}}")}%
\directlua{ly_define_includepaths("\luatexluaescapestring{\commandkey{includepaths}}")}%
\directlua{%
    lilypond_file(
        "\luatexluaescapestring{#1}",
        "\luatexluaescapestring{\currfiledir}",
        '\commandkey{line-width}',
        \luatexluaescapestring{\commandkey{staffsize}},
        \commandkey{fullpage}
    )%
}%
\directlua{ly_define_program("\luatexluaescapestring{\lyluatex@program}")}%
\directlua{ly_define_includepaths("\luatexluaescapestring{\lyluatex@includepaths}")}%
}

% Base environment to include a LilyPond fragment integrated into
% the document.
\NewEnviron{compilerly}{%
\directlua{%
    lilypond_fragment(
        "\luatexluaescapestring{\unexpanded\expandafter{\BODY}}",
        '\localwidth',
        \luatexluaescapestring{\localstaffsize}
    )%
}%
}

% Parametrized command and environment for included LilyPond fragment
\newkeycommand{\lily}[%
    staffsize=\staffsize%
    ,line-width=\lilywidth%
    ,program=\lyluatex@program%
    ,includepaths=\lyluatex@includepaths%
    ][other-options][1]{%
\directlua{ly_define_program("\luatexluaescapestring{\commandkey{program}}")}%
\directlua{ly_define_includepaths("\luatexluaescapestring{\commandkey{includepaths}}")}%
\def\localstaffsize{\commandkey{staffsize}}%
\def\localwidth{\commandkey{line-width}}%
\begin{compilerly}%
{#1}
\end{compilerly}%
\directlua{ly_define_program("\luatexluaescapestring{\lyluatex@program}")}%
\directlua{ly_define_includepaths("\luatexluaescapestring{\lyluatex@includepaths}")}%
}

\newkeyenvironment{ly}[%
    staffsize=\staffsize%
    ,line-width=\lilywidth%
    ,program=\lyluatex@program%
    ,includepaths=\lyluatex@includepaths%
    ][other-options]{%
\directlua{ly_define_program("\luatexluaescapestring{\commandkey{program}}")}%
\directlua{ly_define_includepaths("\luatexluaescapestring{\commandkey{includepaths}}")}%
\def\localstaffsize{\commandkey{staffsize}}%
\def\localwidth{\commandkey{line-width}}%
\compilerly%
}{%
\endcompilerly%
\directlua{ly_define_program("\luatexluaescapestring{\lyluatex@program}")}%
\directlua{ly_define_includepaths("\luatexluaescapestring{\lyluatex@includepaths}")}%
}

% Commands for compatibility with lilypond-book
\let\lilypondfile\includely
\protected\def\lilypond{\def\reserved@a{lilypond}%
  \ifx\reserved@a\@currenvir \expandafter \ly
  \else \expandafter\lily \fi}
\let\endlilypond\endly
